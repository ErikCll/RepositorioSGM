using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Data.SqlClient;
using System.Data;
namespace Operacion.Clase
{
    public class ResumenMaterial
    {
        private Conexion conexion = new Conexion();
        SqlCommand comm = new SqlCommand();
        DataTable dt = new DataTable();
        SqlDataAdapter da;
        SqlDataReader dr;
        public string PromedioHora { get; set; }

        public string Turno1 { get; set; }
        public string Turno2 { get; set; }

        public string Turno3 { get; set; }

        public DataTable MostrarHoras(int IdInstalacion, int Anio, int Mes)
        {

            string query = "SELECT t.Fecha,CONVERT(varchar, CAST(AVG(CAST(t.t1 as decimal (8, 3))) as money), 1)'Turno1', CONVERT(varchar, CAST(AVG(CAST(t.t2 as decimal (8, 3))) as money), 1)'Turno2',CONVERT(varchar, CAST(AVG(CAST(t.t3 as decimal (8, 3))) as money), 1)'Turno3' from(SELECT a.Id_equipo, a.Equipo, a.Fecha,CAST(CAST(t1.Velocidad / ((t1.Elasticidad / 100 + 1) * t1.NoPasada) * .60 as decimal(8, 3)) * .85 * t1.Bandas * a.Turno1 as money) 't1',CAST(CAST(t2.Velocidad /((t2.Elasticidad / 100 + 1) * t2.NoPasada) * .60 as decimal(8, 3)) * .85 * t2.Bandas * a.Turno2 as money) 't2',CAST(CAST(t3.Velocidad /((t3.Elasticidad / 100 + 1) * t3.NoPasada) * .60 as decimal(8, 3)) * .85 * t3.Bandas * a.Turno3 as money) 't3' FROM(SELECT t.Id_equipo, t.Nombre 'Equipo', CONVERT(NVARCHAR, t.Fecha, 105) Fecha, t.T1 'Turno1', t.T2 'Turno2', t.T3 'Turno3' FROM(SELECT a.[Id_equipo], b.Nombre,CASE WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= inicio AND CONVERT(Time(0), fin_averia) < fin THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) > '23:00:00.0000000' THEN CONVERT(date, DATEADD(day, 1, fin_averia)) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), fin_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), fin_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) <= '23:59:00.0000000' THEN CONVERT(date, DATEADD(day, 1, fin_averia)) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '07:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0 THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), fin_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '15:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000'  AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0 THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '23:00:00.0000000'  THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), fin_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000'  THEN CONVERT(date, fin_averia) END AS Fecha, CAST(8 - SUM(CASE WHEN c.Nombre = 'Turno1' THEN CASE WHEN CONVERT(Time(0), ini_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN DATEDIFF(minute, ini_averia, fin_averia) ELSE CASE WHEN CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN DATEDIFF(minute, ini_averia, fin_averia) ELSE CASE WHEN CONVERT(Time(0), ini_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) > '23:00:00.0000000' THEN DATEDIFF(minute, ini_averia, fin_averia) ELSE CASE WHEN CONVERT(Time(0), fin_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN DATEDIFF(minute, '00:00:00.0000000', CONVERT(Time(0), fin_averia)) ELSE CASE WHEN CONVERT(Time(0), fin_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) <= '23:59:00.0000000' THEN DATEDIFF(minute, '23:00:00.0000000', CONVERT(Time(0), fin_averia)) ELSE CASE WHEN CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '07:00:00.0000000' THEN DATEDIFF(minute, CONVERT(Time(0), ini_averia), '07:00:00.0000000') ELSE NULL END END END END END END END) * 1.0 / 60 * 1.0 AS DECIMAL(10, 1)) AS 'T1', CAST(8 - SUM(CASE WHEN c.Nombre = 'Turno2' THEN CASE WHEN CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0 THEN DATEDIFF(minute, ini_averia, fin_averia) ELSE CASE WHEN CONVERT(Time(0), fin_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' THEN DATEDIFF(minute, '07:00:00.0000000', CONVERT(Time(0), fin_averia)) ELSE CASE WHEN CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '15:00:00.0000000' THEN DATEDIFF(minute, CONVERT(Time(0), ini_averia), '15:00:00.0000000') ELSE NULL END END END END) * 1.0 / 60 * 1.0 AS DECIMAL(10, 1)) AS 'T2', CAST(8 - SUM(CASE WHEN c.Nombre = 'Turno3' THEN CASE WHEN CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000' AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0 THEN DATEDIFF(minute, ini_averia, fin_averia) ELSE CASE WHEN CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '23:00:00.0000000' THEN DATEDIFF(minute, CONVERT(Time(0), ini_averia), '23:00:00.0000000') ELSE CASE WHEN CONVERT(Time(0), fin_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000' THEN DATEDIFF(minute, '15:00:00.0000000', CONVERT(Time(0), fin_averia)) ELSE NULL END END END END) * 1.0 / 60 * 1.0 AS DECIMAL(10, 1)) AS 'T3' FROM[orygon].[dbo].[op_fallas] a INNER JOIN Cat_equipo b ON a.Id_equipo = b.Id_equipo INNER JOIN Cat_Turno c ON b.Id_instalacion = c.Id_instalacion WHERE b.Id_instalacion = @HIdInstalacion AND DATEDIFF(minute, ini_averia, fin_averia) > 2 and b.Activado IS NULL GROUP BY a.[Id_equipo], b.Nombre, CASE WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= inicio AND CONVERT(Time(0), fin_averia) < fin THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) > '23:00:00.0000000' THEN CONVERT(date, DATEADD(day, 1, fin_averia)) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), fin_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), fin_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) <= '23:59:00.0000000' THEN CONVERT(date, DATEADD(day, 1, fin_averia)) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '07:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0 THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), fin_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '15:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000'  AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0  THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '23:00:00.0000000'  THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), fin_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000'  THEN CONVERT(date, fin_averia) END) t WHERE t.Fecha IS NOT NULL AND MONTH(t.Fecha) = @HMes AND YEAR(t.Fecha) = @HAnio) a LEFT JOIN(SELECT  pram.Id_Equipo, pram.Fecha, pram.Velocidad, pram.Elasticidad, pram.Bandas, mat.NoPasada, CONVERT(NVARCHAR, CAST(pram.Fecha AS Date), 105) 'Fecha2' FROM Op_ParametrosOperacion pram JOIN(SELECT DISTINCT max(fecha) 'Fecha' from Op_ParametrosOperacion WHERE Activado IS NULL AND CONVERT(Time(0), fecha) >= '00:00:00.0000000' AND CONVERT(Time(0), fecha) < '07:00:00.0000000' AND MONTH(Fecha)=@HMes AND YEAR(Fecha)=@HAnio GROUP BY CAST(Fecha as DATE)) t on pram.Fecha = t.Fecha LEFT JOIN Cat_Material mat on pram.Id_Material = mat.Id_Material) t1 on a.Id_equipo = t1.Id_Equipo and a.Fecha = t1.Fecha2 LEFT JOIN(SELECT pram.Id_Equipo, pram.Fecha, pram.Velocidad, pram.Elasticidad, pram.Bandas, mat.NoPasada, CONVERT(NVARCHAR, CAST(pram.Fecha AS Date), 105) 'Fecha2' FROM Op_ParametrosOperacion pram JOIN(SELECT DISTINCT max(fecha) 'Fecha' from Op_ParametrosOperacion WHERE Activado IS NULL AND CONVERT(Time(0), fecha) >= '07:00:00.0000000' AND CONVERT(Time(0), fecha) < '15:00:00.0000000' AND MONTH(Fecha)=@HMes AND YEAR(Fecha)=@HAnio GROUP BY CAST(Fecha as DATE)) t on pram.Fecha = t.Fecha LEFT JOIN Cat_Material mat on pram.Id_Material = mat.Id_Material) t2 on a.Id_Equipo = t2.Id_Equipo and a.Fecha = t2.Fecha2 LEFT JOIN(SELECT pram.Id_Equipo, pram.Fecha, pram.Velocidad, pram.Elasticidad, pram.Bandas, mat.NoPasada, CONVERT(NVARCHAR, CAST(pram.Fecha AS Date), 105) 'Fecha2' FROM Op_ParametrosOperacion pram JOIN(SELECT DISTINCT max(fecha) 'Fecha' from Op_ParametrosOperacion WHERE Activado IS NULL AND CONVERT(Time(0), fecha) >= '15:00:00.0000000' AND CONVERT(Time(0), fecha) < '23:00:00.0000000' AND MONTH(Fecha)=@HMes AND YEAR(Fecha)=@HAnio GROUP BY CAST(Fecha as DATE)) t on pram.Fecha = t.Fecha LEFT JOIN Cat_Material mat on pram.Id_Material = mat.Id_Material) t3 on a.Id_Equipo = t3.Id_Equipo and a.Fecha = t3.Fecha2)t GROUP BY t.Fecha ORDER BY t.Fecha DESC";

            comm.Connection = conexion.AbrirConexion();
            comm.CommandText = query;
            comm.CommandType = CommandType.Text;
            comm.Parameters.AddWithValue("@HIdInstalacion", IdInstalacion);
            comm.Parameters.AddWithValue("@HMes", Mes);
            comm.Parameters.AddWithValue("@HAnio", Anio);



            da = new SqlDataAdapter(comm);
            dt = new DataTable();
            da.Fill(dt);
            comm.Parameters.Clear();

            conexion.CerrarConexion();
            return dt;

        }

        public DataTable MostrarHorasPorEquipo(int IdEquipo, int Anio, int Mes)
        {

            string query = "SELECT t.Fecha,CONVERT(varchar, CAST(AVG(CAST(t.t1 as decimal (8, 3))) as money), 1)'Turno1', CONVERT(varchar, CAST(AVG(CAST(t.t2 as decimal (8, 3))) as money), 1)'Turno2',CONVERT(varchar, CAST(AVG(CAST(t.t3 as decimal (8, 3))) as money), 1)'Turno3' from(SELECT a.Id_equipo, a.Equipo, a.Fecha,CAST(CAST(t1.Velocidad / ((t1.Elasticidad / 100 + 1) * t1.NoPasada) * .60 as decimal(8, 3)) * .85 * t1.Bandas * a.Turno1 as money) 't1',CAST(CAST(t2.Velocidad /((t2.Elasticidad / 100 + 1) * t2.NoPasada) * .60 as decimal(8, 3)) * .85 * t2.Bandas * a.Turno2 as money) 't2',CAST(CAST(t3.Velocidad /((t3.Elasticidad / 100 + 1) * t3.NoPasada) * .60 as decimal(8, 3)) * .85 * t3.Bandas * a.Turno3 as money) 't3' FROM(SELECT t.Id_equipo, t.Nombre 'Equipo', CONVERT(NVARCHAR, t.Fecha, 105) Fecha, t.T1 'Turno1', t.T2 'Turno2', t.T3 'Turno3' FROM(SELECT a.[Id_equipo], b.Nombre,CASE WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= inicio AND CONVERT(Time(0), fin_averia) < fin THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) > '23:00:00.0000000' THEN CONVERT(date, DATEADD(day, 1, fin_averia)) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), fin_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), fin_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) <= '23:59:00.0000000' THEN CONVERT(date, DATEADD(day, 1, fin_averia)) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '07:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0 THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), fin_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '15:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000'  AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0 THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '23:00:00.0000000'  THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), fin_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000'  THEN CONVERT(date, fin_averia) END AS Fecha, CAST(8 - SUM(CASE WHEN c.Nombre = 'Turno1' THEN CASE WHEN CONVERT(Time(0), ini_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN DATEDIFF(minute, ini_averia, fin_averia) ELSE CASE WHEN CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN DATEDIFF(minute, ini_averia, fin_averia) ELSE CASE WHEN CONVERT(Time(0), ini_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) > '23:00:00.0000000' THEN DATEDIFF(minute, ini_averia, fin_averia) ELSE CASE WHEN CONVERT(Time(0), fin_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN DATEDIFF(minute, '00:00:00.0000000', CONVERT(Time(0), fin_averia)) ELSE CASE WHEN CONVERT(Time(0), fin_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) <= '23:59:00.0000000' THEN DATEDIFF(minute, '23:00:00.0000000', CONVERT(Time(0), fin_averia)) ELSE CASE WHEN CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '07:00:00.0000000' THEN DATEDIFF(minute, CONVERT(Time(0), ini_averia), '07:00:00.0000000') ELSE NULL END END END END END END END) * 1.0 / 60 * 1.0 AS DECIMAL(10, 1)) AS 'T1', CAST(8 - SUM(CASE WHEN c.Nombre = 'Turno2' THEN CASE WHEN CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0 THEN DATEDIFF(minute, ini_averia, fin_averia) ELSE CASE WHEN CONVERT(Time(0), fin_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' THEN DATEDIFF(minute, '07:00:00.0000000', CONVERT(Time(0), fin_averia)) ELSE CASE WHEN CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '15:00:00.0000000' THEN DATEDIFF(minute, CONVERT(Time(0), ini_averia), '15:00:00.0000000') ELSE NULL END END END END) * 1.0 / 60 * 1.0 AS DECIMAL(10, 1)) AS 'T2', CAST(8 - SUM(CASE WHEN c.Nombre = 'Turno3' THEN CASE WHEN CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000' AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0 THEN DATEDIFF(minute, ini_averia, fin_averia) ELSE CASE WHEN CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '23:00:00.0000000' THEN DATEDIFF(minute, CONVERT(Time(0), ini_averia), '23:00:00.0000000') ELSE CASE WHEN CONVERT(Time(0), fin_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000' THEN DATEDIFF(minute, '15:00:00.0000000', CONVERT(Time(0), fin_averia)) ELSE NULL END END END END) * 1.0 / 60 * 1.0 AS DECIMAL(10, 1)) AS 'T3' FROM[orygon].[dbo].[op_fallas] a INNER JOIN Cat_equipo b ON a.Id_equipo = b.Id_equipo INNER JOIN Cat_Turno c ON b.Id_instalacion = c.Id_instalacion WHERE b.Id_Equipo = @HIdEquipo AND DATEDIFF(minute, ini_averia, fin_averia) > 2 and b.Activado IS NULL GROUP BY a.[Id_equipo], b.Nombre, CASE WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= inicio AND CONVERT(Time(0), fin_averia) < fin THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) > '23:00:00.0000000' THEN CONVERT(date, DATEADD(day, 1, fin_averia)) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), fin_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), fin_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) <= '23:59:00.0000000' THEN CONVERT(date, DATEADD(day, 1, fin_averia)) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '07:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0 THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), fin_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '15:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000'  AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0  THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '23:00:00.0000000'  THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), fin_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000'  THEN CONVERT(date, fin_averia) END) t WHERE t.Fecha IS NOT NULL AND MONTH(t.Fecha) = @HMes AND YEAR(t.Fecha) = @HAnio) a LEFT JOIN(SELECT  pram.Id_Equipo, pram.Fecha, pram.Velocidad, pram.Elasticidad, pram.Bandas, mat.NoPasada, CONVERT(NVARCHAR, CAST(pram.Fecha AS Date), 105) 'Fecha2' FROM Op_ParametrosOperacion pram JOIN(SELECT DISTINCT max(fecha) 'Fecha' from Op_ParametrosOperacion WHERE Activado IS NULL AND CONVERT(Time(0), fecha) >= '00:00:00.0000000' AND CONVERT(Time(0), fecha) < '07:00:00.0000000' AND MONTH(Fecha)=@HMes AND YEAR(Fecha)=@HAnio GROUP BY CAST(Fecha as DATE)) t on pram.Fecha = t.Fecha LEFT JOIN Cat_Material mat on pram.Id_Material = mat.Id_Material) t1 on a.Id_equipo = t1.Id_Equipo and a.Fecha = t1.Fecha2 LEFT JOIN(SELECT pram.Id_Equipo, pram.Fecha, pram.Velocidad, pram.Elasticidad, pram.Bandas, mat.NoPasada, CONVERT(NVARCHAR, CAST(pram.Fecha AS Date), 105) 'Fecha2' FROM Op_ParametrosOperacion pram JOIN(SELECT DISTINCT max(fecha) 'Fecha' from Op_ParametrosOperacion WHERE Activado IS NULL AND CONVERT(Time(0), fecha) >= '07:00:00.0000000' AND CONVERT(Time(0), fecha) < '15:00:00.0000000' AND MONTH(Fecha)=@HMes AND YEAR(Fecha)=@HAnio GROUP BY CAST(Fecha as DATE)) t on pram.Fecha = t.Fecha LEFT JOIN Cat_Material mat on pram.Id_Material = mat.Id_Material) t2 on a.Id_Equipo = t2.Id_Equipo and a.Fecha = t2.Fecha2 LEFT JOIN(SELECT pram.Id_Equipo, pram.Fecha, pram.Velocidad, pram.Elasticidad, pram.Bandas, mat.NoPasada, CONVERT(NVARCHAR, CAST(pram.Fecha AS Date), 105) 'Fecha2' FROM Op_ParametrosOperacion pram JOIN(SELECT DISTINCT max(fecha) 'Fecha' from Op_ParametrosOperacion WHERE Activado IS NULL AND CONVERT(Time(0), fecha) >= '15:00:00.0000000' AND CONVERT(Time(0), fecha) < '23:00:00.0000000' AND MONTH(Fecha)=@HMes AND YEAR(Fecha)=@HAnio GROUP BY CAST(Fecha as DATE)) t on pram.Fecha = t.Fecha LEFT JOIN Cat_Material mat on pram.Id_Material = mat.Id_Material) t3 on a.Id_Equipo = t3.Id_Equipo and a.Fecha = t3.Fecha2)t GROUP BY t.Fecha ORDER BY t.Fecha DESC";


            comm.Connection = conexion.AbrirConexion();
            comm.CommandText = query;
            comm.CommandType = CommandType.Text;
            comm.Parameters.AddWithValue("@HIdEquipo", IdEquipo);
            comm.Parameters.AddWithValue("@HMes", Mes);
            comm.Parameters.AddWithValue("@HAnio", Anio);



            da = new SqlDataAdapter(comm);
            dt = new DataTable();
            da.Fill(dt);
            comm.Parameters.Clear();

            conexion.CerrarConexion();
            return dt;

        }

        public DataTable MostrarDetalleHoras(int IdInstalacion, string Fecha)
        {

            string query = "SELECT a.Id_equipo,a.Equipo,a.Fecha, CONVERT(varchar, CAST(CAST(t1.Velocidad / ((t1.Elasticidad / 100 + 1) * t1.NoPasada) * .60 as decimal(8, 3)) * .85 * t1.Bandas * a.Turno1 as money), 1) 'Turno1', CONVERT(varchar, CAST(CAST(t2.Velocidad / ((t2.Elasticidad / 100 + 1) * t2.NoPasada) * .60 as decimal(8, 3)) * .85 * t2.Bandas * a.Turno2 as money), 1) 'Turno2', CONVERT(varchar, CAST(CAST(t3.Velocidad / ((t3.Elasticidad / 100 + 1) * t3.NoPasada) * .60 as decimal(8, 3)) * .85 * t3.Bandas * a.Turno3 as money), 1) 'Turno3' FROM(SELECT t.Id_equipo, t.Nombre 'Equipo', CONVERT(NVARCHAR, t.Fecha, 105) Fecha, t.T1 'Turno1', t.T2 'Turno2', t.T3 'Turno3' FROM(SELECT a.[Id_equipo], b.Nombre, CASE WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= inicio AND CONVERT(Time(0), fin_averia) < fin THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) > '23:00:00.0000000' THEN CONVERT(date, DATEADD(day, 1, fin_averia)) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), fin_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), fin_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) <= '23:59:00.0000000' THEN CONVERT(date, DATEADD(day, 1, fin_averia)) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '07:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0 THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), fin_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '15:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000'  AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0 THEN CONVERT(date, ini_averia)  WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '23:00:00.0000000'  THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), fin_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000'  THEN CONVERT(date, fin_averia) END AS Fecha, CAST(8 - SUM(CASE WHEN c.Nombre = 'Turno1' THEN CASE WHEN CONVERT(Time(0), ini_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN DATEDIFF(minute, ini_averia, fin_averia) ELSE CASE WHEN CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN DATEDIFF(minute, ini_averia, fin_averia) ELSE CASE WHEN CONVERT(Time(0), ini_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) > '23:00:00.0000000' THEN DATEDIFF(minute, ini_averia, fin_averia) ELSE CASE WHEN CONVERT(Time(0), fin_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN DATEDIFF(minute, '00:00:00.0000000', CONVERT(Time(0), fin_averia)) ELSE CASE WHEN CONVERT(Time(0), fin_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) <= '23:59:00.0000000' THEN DATEDIFF(minute, '23:00:00.0000000', CONVERT(Time(0), fin_averia)) ELSE CASE WHEN CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '07:00:00.0000000' THEN DATEDIFF(minute, CONVERT(Time(0), ini_averia), '07:00:00.0000000') ELSE NULL END END END END END END END) * 1.0 / 60 * 1.0 AS DECIMAL(10, 1)) AS 'T1', CAST(8 - SUM(CASE WHEN c.Nombre = 'Turno2' THEN CASE WHEN CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0 THEN DATEDIFF(minute, ini_averia, fin_averia) ELSE CASE WHEN CONVERT(Time(0), fin_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' THEN DATEDIFF(minute, '07:00:00.0000000', CONVERT(Time(0), fin_averia)) ELSE CASE WHEN CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '15:00:00.0000000' THEN DATEDIFF(minute, CONVERT(Time(0), ini_averia), '15:00:00.0000000') ELSE NULL END END END END) * 1.0 / 60 * 1.0 AS DECIMAL(10, 1)) AS 'T2', CAST(8 - SUM(CASE WHEN c.Nombre = 'Turno3' THEN CASE WHEN CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000' AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0 THEN DATEDIFF(minute, ini_averia, fin_averia) ELSE CASE WHEN CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '23:00:00.0000000' THEN DATEDIFF(minute, CONVERT(Time(0), ini_averia), '23:00:00.0000000') ELSE CASE WHEN CONVERT(Time(0), fin_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000' THEN DATEDIFF(minute, '15:00:00.0000000', CONVERT(Time(0), fin_averia)) ELSE NULL END END END END) * 1.0 / 60 * 1.0 AS DECIMAL(10, 1)) AS 'T3'  FROM[orygon].[dbo].[op_fallas] a INNER JOIN Cat_equipo b ON a.Id_equipo = b.Id_equipo INNER JOIN Cat_Turno c ON b.Id_instalacion = c.Id_instalacion WHERE b.Id_instalacion = @HIdInstalacion AND DATEDIFF(minute, ini_averia, fin_averia) > 2 and b.Activado IS NULL GROUP BY a.[Id_equipo], b.Nombre, CASE WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= inicio AND CONVERT(Time(0), fin_averia) < fin THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) > '23:00:00.0000000' THEN CONVERT(date, DATEADD(day, 1, fin_averia)) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), fin_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), fin_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) <= '23:59:00.0000000' THEN CONVERT(date, DATEADD(day, 1, fin_averia)) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '07:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0 THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), fin_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '15:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000'  AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0  THEN CONVERT(date, ini_averia)  WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '23:00:00.0000000'  THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), fin_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000'  THEN CONVERT(date, fin_averia) END) t WHERE t.Fecha IS NOT NULL AND CONVERT(NVARCHAR, CAST(t.Fecha AS Date), 105) = @HFecha) a LEFT JOIN(SELECT  pram.Id_Equipo, pram.Fecha, pram.Velocidad, pram.Elasticidad, pram.Bandas, mat.NoPasada, CONVERT(NVARCHAR, CAST(pram.Fecha AS Date), 105) 'Fecha2' FROM Op_ParametrosOperacion pram JOIN(SELECT DISTINCT max(fecha) 'Fecha' from Op_ParametrosOperacion WHERE Activado IS NULL AND CONVERT(Time(0), fecha) >= '00:00:00.0000000' AND CONVERT(Time(0), fecha) < '07:00:00.0000000' AND CONVERT(NVARCHAR, CAST(Fecha AS Date), 105) = @HFecha GROUP BY CAST(Fecha as DATE)) t on pram.Fecha = t.Fecha LEFT JOIN Cat_Material mat on pram.Id_Material = mat.Id_Material) t1 on a.Id_equipo = t1.Id_Equipo and a.Fecha = t1.Fecha2 LEFT JOIN(SELECT pram.Id_Equipo, pram.Fecha, pram.Velocidad, pram.Elasticidad , pram.Bandas, mat.NoPasada, CONVERT(NVARCHAR, CAST(pram.Fecha AS Date),105) 'Fecha2' FROM Op_ParametrosOperacion pram JOIN(SELECT DISTINCT max(fecha) 'Fecha' from Op_ParametrosOperacion WHERE Activado IS NULL AND CONVERT(Time(0), fecha) >= '07:00:00.0000000' AND CONVERT(Time(0), fecha) < '15:00:00.0000000' AND CONVERT(NVARCHAR, CAST(Fecha AS Date), 105) = @HFecha GROUP BY CAST(Fecha as DATE)) t on pram.Fecha = t.Fecha LEFT JOIN Cat_Material mat on pram.Id_Material = mat.Id_Material) t2 on a.Id_Equipo = t2.Id_Equipo and a.Fecha = t2.Fecha2 LEFT JOIN(SELECT pram.Id_Equipo, pram.Fecha, pram.Velocidad, pram.Elasticidad , pram.Bandas, mat.NoPasada, CONVERT(NVARCHAR, CAST(pram.Fecha AS Date),105) 'Fecha2' FROM Op_ParametrosOperacion pram JOIN(SELECT DISTINCT max(fecha) 'Fecha' from Op_ParametrosOperacion WHERE Activado IS NULL AND CONVERT(Time(0), fecha) >= '15:00:00.0000000' AND CONVERT(Time(0), fecha) < '23:00:00.0000000' AND CONVERT(NVARCHAR, CAST(Fecha AS Date), 105) = @HFecha GROUP BY CAST(Fecha as DATE)) t on pram.Fecha = t.Fecha LEFT JOIN Cat_Material mat on pram.Id_Material = mat.Id_Material) t3 on a.Id_Equipo = t3.Id_Equipo and a.Fecha = t3.Fecha2 ORDER BY a.Id_equipo ASC";


            comm.Connection = conexion.AbrirConexion();
            comm.CommandText = query;
            comm.CommandType = CommandType.Text;
            comm.Parameters.AddWithValue("@HFecha", Fecha);
            comm.Parameters.AddWithValue("@HIdInstalacion", IdInstalacion);





            da = new SqlDataAdapter(comm);
            dt = new DataTable();
            da.Fill(dt);
            comm.Parameters.Clear();

            conexion.CerrarConexion();
            return dt;

        }

        public DataTable MostrarMeses(int IdInstalacion)
        {

            comm.Connection = conexion.AbrirConexion();
            comm.CommandText = "SELECT MONTH(prod.Fecha) 'Mes' FROM Op_Produccion prod JOIN Cat_Equipo equi on prod.Id_Equipo = equi.Id_Equipo JOIN Cat_Instalacion ins on equi.Id_Instalacion = ins.Id_Instalacion WHERE ins.Id_Instalacion = @IdInstalacion GROUP BY MONTH(prod.Fecha) ORDER BY MONTH(prod.Fecha) DESC";
            comm.CommandType = CommandType.Text;
            comm.Parameters.AddWithValue("@IdInstalacion", IdInstalacion);

            da = new SqlDataAdapter(comm);
            dt = new DataTable();
            da.Fill(dt);
            comm.Parameters.Clear();
            conexion.CerrarConexion();
            return dt;

        }

        public DataTable MostrarAnios(int IdInstalacion)
        {

            comm.Connection = conexion.AbrirConexion();
            comm.CommandText = "SELECT YEAR(prod.Fecha) 'Anio' FROM Op_Produccion prod JOIN Cat_Equipo equi on prod.Id_Equipo = equi.Id_Equipo JOIN Cat_Instalacion ins on equi.Id_Instalacion = ins.Id_Instalacion WHERE ins.Id_Instalacion = @IdInstalacionn GROUP BY YEAR(prod.Fecha) ORDER BY YEAR(prod.Fecha) DESC";
            comm.CommandType = CommandType.Text;
            comm.Parameters.AddWithValue("@IdInstalacionn", IdInstalacion);

            da = new SqlDataAdapter(comm);
            dt = new DataTable();
            da.Fill(dt);
            comm.Parameters.Clear();
            conexion.CerrarConexion();
            return dt;

        }

        public DataTable MostrarEquipo(int IdInstalacion)
        {

            comm.Connection = conexion.AbrirConexion();
            comm.CommandText = "SELECT Id_Equipo, Nombre FROM Cat_Equipo WHERE Id_instalacion = @EIdInstalacionn AND Activado IS NULL AND IP IS NOT NULL ORDER BY Id_equipo DESC";
            comm.CommandType = CommandType.Text;
            comm.Parameters.AddWithValue("@EIdInstalacionn", IdInstalacion);

            da = new SqlDataAdapter(comm);
            dt = new DataTable();
            da.Fill(dt);
            comm.Parameters.Clear();
            conexion.CerrarConexion();
            return dt;

        }


        public void LeerDatosHorasTurno(int IdInstalacion, int Anio, int Mes)
        {
            comm.Connection = conexion.AbrirConexion();
            comm.CommandText = "SELECT ISNULL(CONVERT(varchar,CAST(CAST(AVG(t2.Turno1) as DECIMAL(10,2)) as money),1) ,0) 'Turno1',ISNULL(CONVERT(varchar, CAST(CAST(AVG(t2.Turno2) as DECIMAL(10, 2)) as money), 1), 0) 'Turno2', ISNULL(CONVERT(varchar, CAST(CAST(AVG(t2.Turno3) as DECIMAL(10, 2)) as money), 1), 0) 'Turno3' FROM(SELECT t.Fecha, CAST(AVG(CAST(t.t1 as decimal (8, 3))) as money)'Turno1', CAST(AVG(CAST(t.t2 as decimal (8, 3))) as money)'Turno2', CAST(AVG(CAST(t.t3 as decimal (8, 3))) as money)'Turno3' from(SELECT a.Id_equipo, a.Equipo, a.Fecha, CAST(CAST(t1.Velocidad / ((t1.Elasticidad / 100 + 1) * t1.NoPasada) * .60 as decimal(8, 3)) * .85 * t1.Bandas * a.Turno1 as money) 't1', CAST(CAST(t2.Velocidad / ((t2.Elasticidad / 100 + 1) * t2.NoPasada) * .60 as decimal(8, 3)) * .85 * t2.Bandas * a.Turno2 as money) 't2', CAST(CAST(t3.Velocidad / ((t3.Elasticidad / 100 + 1) * t3.NoPasada) * .60 as decimal(8, 3)) * .85 * t3.Bandas * a.Turno3 as money) 't3' FROM(SELECT t.Id_equipo, t.Nombre 'Equipo', CONVERT(NVARCHAR, t.Fecha, 105) Fecha, t.T1 'Turno1', t.T2 'Turno2', t.T3 'Turno3' FROM(SELECT a.[Id_equipo], b.Nombre, CASE WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= inicio AND CONVERT(Time(0), fin_averia) < fin THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) > '23:00:00.0000000' THEN CONVERT(date, DATEADD(day, 1, fin_averia)) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), fin_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), fin_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) <= '23:59:00.0000000' THEN CONVERT(date, DATEADD(day, 1, fin_averia)) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '07:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0 THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), fin_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '15:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000'  AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0 THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '23:00:00.0000000'  THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), fin_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000'  THEN CONVERT(date, fin_averia) END AS Fecha, CAST(8 - SUM(CASE WHEN c.Nombre = 'Turno1' THEN CASE WHEN CONVERT(Time(0), ini_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN DATEDIFF(minute, ini_averia, fin_averia) ELSE CASE WHEN CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN DATEDIFF(minute, ini_averia, fin_averia) ELSE CASE WHEN CONVERT(Time(0), ini_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) > '23:00:00.0000000' THEN DATEDIFF(minute, ini_averia, fin_averia) ELSE CASE WHEN CONVERT(Time(0), fin_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN DATEDIFF(minute, '00:00:00.0000000', CONVERT(Time(0), fin_averia)) ELSE CASE WHEN CONVERT(Time(0), fin_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) <= '23:59:00.0000000' THEN DATEDIFF(minute, '23:00:00.0000000', CONVERT(Time(0), fin_averia)) ELSE CASE WHEN CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '07:00:00.0000000' THEN DATEDIFF(minute, CONVERT(Time(0), ini_averia), '07:00:00.0000000') ELSE NULL END END END END END END END) * 1.0 / 60 * 1.0 AS DECIMAL(10, 1)) AS 'T1', CAST(8 - SUM(CASE WHEN c.Nombre = 'Turno2' THEN CASE WHEN CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0 THEN DATEDIFF(minute, ini_averia, fin_averia) ELSE CASE WHEN CONVERT(Time(0), fin_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' THEN DATEDIFF(minute, '07:00:00.0000000', CONVERT(Time(0), fin_averia)) ELSE CASE WHEN CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '15:00:00.0000000' THEN DATEDIFF(minute, CONVERT(Time(0), ini_averia), '15:00:00.0000000') ELSE NULL END END END END) * 1.0 / 60 * 1.0 AS DECIMAL(10, 1)) AS 'T2', CAST(8 - SUM(CASE WHEN c.Nombre = 'Turno3' THEN CASE WHEN CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000' AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0 THEN DATEDIFF(minute, ini_averia, fin_averia) ELSE CASE WHEN CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '23:00:00.0000000' THEN DATEDIFF(minute, CONVERT(Time(0), ini_averia), '23:00:00.0000000') ELSE CASE WHEN CONVERT(Time(0), fin_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000' THEN DATEDIFF(minute, '15:00:00.0000000', CONVERT(Time(0), fin_averia)) ELSE NULL END END END END) * 1.0 / 60 * 1.0 AS DECIMAL(10, 1)) AS 'T3' FROM[orygon].[dbo].[op_fallas] a INNER JOIN Cat_equipo b ON a.Id_equipo = b.Id_equipo INNER JOIN Cat_Turno c ON b.Id_instalacion = c.Id_instalacion WHERE b.Id_instalacion = @IHIdInstalacion AND DATEDIFF(minute, ini_averia, fin_averia) > 2 and b.Activado IS NULL GROUP BY a.[Id_equipo], b.Nombre, CASE WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= inicio AND CONVERT(Time(0), fin_averia) < fin THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) > '23:00:00.0000000' THEN CONVERT(date, DATEADD(day, 1, fin_averia)) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), fin_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), fin_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) <= '23:59:00.0000000' THEN CONVERT(date, DATEADD(day, 1, fin_averia)) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '07:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0 THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), fin_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '15:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000'  AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0  THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '23:00:00.0000000'  THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), fin_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000'  THEN CONVERT(date, fin_averia) END) t WHERE t.Fecha IS NOT NULL AND MONTH(t.Fecha) = @IHMes AND YEAR(t.Fecha) = @IHAnio) a LEFT JOIN(SELECT  pram.Id_Equipo, pram.Fecha, pram.Velocidad, pram.Elasticidad, pram.Bandas, mat.NoPasada, CONVERT(NVARCHAR, CAST(pram.Fecha AS Date), 105) 'Fecha2' FROM Op_ParametrosOperacion pram JOIN(SELECT DISTINCT max(fecha) 'Fecha' from Op_ParametrosOperacion WHERE Activado IS NULL AND CONVERT(Time(0), fecha) >= '00:00:00.0000000' AND CONVERT(Time(0), fecha) < '07:00:00.0000000' AND MONTH(Fecha)=@IHMes AND YEAR(Fecha)=@IHAnio GROUP BY CAST(Fecha as DATE)) t on pram.Fecha = t.Fecha LEFT JOIN Cat_Material mat on pram.Id_Material = mat.Id_Material) t1 on a.Id_equipo = t1.Id_Equipo and a.Fecha = t1.Fecha2 LEFT JOIN(SELECT pram.Id_Equipo, pram.Fecha, pram.Velocidad, pram.Elasticidad, pram.Bandas, mat.NoPasada, CONVERT(NVARCHAR, CAST(pram.Fecha AS Date), 105) 'Fecha2' FROM Op_ParametrosOperacion pram JOIN(SELECT DISTINCT max(fecha) 'Fecha' from Op_ParametrosOperacion WHERE Activado IS NULL AND CONVERT(Time(0), fecha) >= '07:00:00.0000000' AND CONVERT(Time(0), fecha) < '15:00:00.0000000' AND MONTH(Fecha)=@IHMes AND YEAR(Fecha)=@IHAnio GROUP BY CAST(Fecha as DATE)) t on pram.Fecha = t.Fecha LEFT JOIN Cat_Material mat on pram.Id_Material = mat.Id_Material) t2 on a.Id_Equipo = t2.Id_Equipo and a.Fecha = t2.Fecha2 LEFT JOIN(SELECT pram.Id_Equipo, pram.Fecha, pram.Velocidad, pram.Elasticidad, pram.Bandas, mat.NoPasada, CONVERT(NVARCHAR, CAST(pram.Fecha AS Date), 105) 'Fecha2' FROM Op_ParametrosOperacion pram JOIN(SELECT DISTINCT max(fecha) 'Fecha' from Op_ParametrosOperacion WHERE Activado IS NULL AND CONVERT(Time(0), fecha) >= '15:00:00.0000000' AND CONVERT(Time(0), fecha) < '23:00:00.0000000' AND MONTH(Fecha)=@IHMes AND YEAR(Fecha)=@IHAnio GROUP BY CAST(Fecha as DATE)) t on pram.Fecha = t.Fecha LEFT JOIN Cat_Material mat on pram.Id_Material = mat.Id_Material) t3 on a.Id_Equipo = t3.Id_Equipo and a.Fecha = t3.Fecha2)t GROUP BY t.Fecha)t2";
            comm.CommandType = CommandType.Text;
            comm.Parameters.AddWithValue("@IHIdInstalacion", IdInstalacion);
            comm.Parameters.AddWithValue("@IHAnio", Anio);
            comm.Parameters.AddWithValue("@IHMes", Mes);


            dr = comm.ExecuteReader();
            dr.Read();
            Turno1 = dr["Turno1"].ToString();
            Turno2 = dr["Turno2"].ToString();
            Turno3 = dr["Turno3"].ToString();

            dr.Close();
            comm.Parameters.Clear();
            comm.Connection = conexion.CerrarConexion();



        }

        public void LeerDatosHorasTurnoPorEquipo(int IdEquipo, int Anio, int Mes)
        {
            comm.Connection = conexion.AbrirConexion();
            comm.CommandText = "SELECT ISNULL(CONVERT(varchar,CAST(CAST(AVG(t2.Turno1) as DECIMAL(10,2)) as money),1) ,0) 'Turno1',ISNULL(CONVERT(varchar, CAST(CAST(AVG(t2.Turno2) as DECIMAL(10, 2)) as money), 1), 0) 'Turno2', ISNULL(CONVERT(varchar, CAST(CAST(AVG(t2.Turno3) as DECIMAL(10, 2)) as money), 1), 0) 'Turno3' FROM(SELECT t.Fecha, CAST(AVG(CAST(t.t1 as decimal (8, 3))) as money)'Turno1', CAST(AVG(CAST(t.t2 as decimal (8, 3))) as money)'Turno2', CAST(AVG(CAST(t.t3 as decimal (8, 3))) as money)'Turno3' from(SELECT a.Id_equipo, a.Equipo, a.Fecha, CAST(CAST(t1.Velocidad / ((t1.Elasticidad / 100 + 1) * t1.NoPasada) * .60 as decimal(8, 3)) * .85 * t1.Bandas * a.Turno1 as money) 't1', CAST(CAST(t2.Velocidad / ((t2.Elasticidad / 100 + 1) * t2.NoPasada) * .60 as decimal(8, 3)) * .85 * t2.Bandas * a.Turno2 as money) 't2', CAST(CAST(t3.Velocidad / ((t3.Elasticidad / 100 + 1) * t3.NoPasada) * .60 as decimal(8, 3)) * .85 * t3.Bandas * a.Turno3 as money) 't3' FROM(SELECT t.Id_equipo, t.Nombre 'Equipo', CONVERT(NVARCHAR, t.Fecha, 105) Fecha, t.T1 'Turno1', t.T2 'Turno2', t.T3 'Turno3' FROM(SELECT a.[Id_equipo], b.Nombre, CASE WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= inicio AND CONVERT(Time(0), fin_averia) < fin THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) > '23:00:00.0000000' THEN CONVERT(date, DATEADD(day, 1, fin_averia)) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), fin_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), fin_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) <= '23:59:00.0000000' THEN CONVERT(date, DATEADD(day, 1, fin_averia)) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '07:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0 THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), fin_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '15:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000'  AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0 THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '23:00:00.0000000'  THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), fin_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000'  THEN CONVERT(date, fin_averia) END AS Fecha, CAST(8 - SUM(CASE WHEN c.Nombre = 'Turno1' THEN CASE WHEN CONVERT(Time(0), ini_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN DATEDIFF(minute, ini_averia, fin_averia) ELSE CASE WHEN CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN DATEDIFF(minute, ini_averia, fin_averia) ELSE CASE WHEN CONVERT(Time(0), ini_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) > '23:00:00.0000000' THEN DATEDIFF(minute, ini_averia, fin_averia) ELSE CASE WHEN CONVERT(Time(0), fin_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN DATEDIFF(minute, '00:00:00.0000000', CONVERT(Time(0), fin_averia)) ELSE CASE WHEN CONVERT(Time(0), fin_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) <= '23:59:00.0000000' THEN DATEDIFF(minute, '23:00:00.0000000', CONVERT(Time(0), fin_averia)) ELSE CASE WHEN CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '07:00:00.0000000' THEN DATEDIFF(minute, CONVERT(Time(0), ini_averia), '07:00:00.0000000') ELSE NULL END END END END END END END) * 1.0 / 60 * 1.0 AS DECIMAL(10, 1)) AS 'T1', CAST(8 - SUM(CASE WHEN c.Nombre = 'Turno2' THEN CASE WHEN CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0 THEN DATEDIFF(minute, ini_averia, fin_averia) ELSE CASE WHEN CONVERT(Time(0), fin_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' THEN DATEDIFF(minute, '07:00:00.0000000', CONVERT(Time(0), fin_averia)) ELSE CASE WHEN CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '15:00:00.0000000' THEN DATEDIFF(minute, CONVERT(Time(0), ini_averia), '15:00:00.0000000') ELSE NULL END END END END) * 1.0 / 60 * 1.0 AS DECIMAL(10, 1)) AS 'T2', CAST(8 - SUM(CASE WHEN c.Nombre = 'Turno3' THEN CASE WHEN CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000' AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0 THEN DATEDIFF(minute, ini_averia, fin_averia) ELSE CASE WHEN CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '23:00:00.0000000' THEN DATEDIFF(minute, CONVERT(Time(0), ini_averia), '23:00:00.0000000') ELSE CASE WHEN CONVERT(Time(0), fin_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000' THEN DATEDIFF(minute, '15:00:00.0000000', CONVERT(Time(0), fin_averia)) ELSE NULL END END END END) * 1.0 / 60 * 1.0 AS DECIMAL(10, 1)) AS 'T3' FROM[orygon].[dbo].[op_fallas] a INNER JOIN Cat_equipo b ON a.Id_equipo = b.Id_equipo INNER JOIN Cat_Turno c ON b.Id_instalacion = c.Id_instalacion WHERE b.Id_Equipo=@IHIdEquipo AND DATEDIFF(minute, ini_averia, fin_averia) > 2 and b.Activado IS NULL GROUP BY a.[Id_equipo], b.Nombre, CASE WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= inicio AND CONVERT(Time(0), fin_averia) < fin THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) > '23:00:00.0000000' THEN CONVERT(date, DATEADD(day, 1, fin_averia)) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), fin_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), fin_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) <= '23:59:00.0000000' THEN CONVERT(date, DATEADD(day, 1, fin_averia)) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '07:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0 THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), fin_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '15:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000'  AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0  THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '23:00:00.0000000'  THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), fin_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000'  THEN CONVERT(date, fin_averia) END) t WHERE t.Fecha IS NOT NULL AND MONTH(t.Fecha) = @IHMes AND YEAR(t.Fecha) = @IHAnio) a LEFT JOIN(SELECT  pram.Id_Equipo, pram.Fecha, pram.Velocidad, pram.Elasticidad, pram.Bandas, mat.NoPasada, CONVERT(NVARCHAR, CAST(pram.Fecha AS Date), 105) 'Fecha2' FROM Op_ParametrosOperacion pram JOIN(SELECT DISTINCT max(fecha) 'Fecha' from Op_ParametrosOperacion WHERE Activado IS NULL AND CONVERT(Time(0), fecha) >= '00:00:00.0000000' AND CONVERT(Time(0), fecha) < '07:00:00.0000000' AND MONTH(Fecha)=@IHMes AND YEAR(Fecha)=@IHAnio GROUP BY CAST(Fecha as DATE)) t on pram.Fecha = t.Fecha LEFT JOIN Cat_Material mat on pram.Id_Material = mat.Id_Material) t1 on a.Id_equipo = t1.Id_Equipo and a.Fecha = t1.Fecha2 LEFT JOIN(SELECT pram.Id_Equipo, pram.Fecha, pram.Velocidad, pram.Elasticidad, pram.Bandas, mat.NoPasada, CONVERT(NVARCHAR, CAST(pram.Fecha AS Date), 105) 'Fecha2' FROM Op_ParametrosOperacion pram JOIN(SELECT DISTINCT max(fecha) 'Fecha' from Op_ParametrosOperacion WHERE Activado IS NULL AND CONVERT(Time(0), fecha) >= '07:00:00.0000000' AND CONVERT(Time(0), fecha) < '15:00:00.0000000' AND MONTH(Fecha)=@IHMes AND YEAR(Fecha)=@IHAnio GROUP BY CAST(Fecha as DATE)) t on pram.Fecha = t.Fecha LEFT JOIN Cat_Material mat on pram.Id_Material = mat.Id_Material) t2 on a.Id_Equipo = t2.Id_Equipo and a.Fecha = t2.Fecha2 LEFT JOIN(SELECT pram.Id_Equipo, pram.Fecha, pram.Velocidad, pram.Elasticidad, pram.Bandas, mat.NoPasada, CONVERT(NVARCHAR, CAST(pram.Fecha AS Date), 105) 'Fecha2' FROM Op_ParametrosOperacion pram JOIN(SELECT DISTINCT max(fecha) 'Fecha' from Op_ParametrosOperacion WHERE Activado IS NULL AND CONVERT(Time(0), fecha) >= '15:00:00.0000000' AND CONVERT(Time(0), fecha) < '23:00:00.0000000' AND MONTH(Fecha)=@IHMes AND YEAR(Fecha)=@IHAnio GROUP BY CAST(Fecha as DATE)) t on pram.Fecha = t.Fecha LEFT JOIN Cat_Material mat on pram.Id_Material = mat.Id_Material) t3 on a.Id_Equipo = t3.Id_Equipo and a.Fecha = t3.Fecha2)t GROUP BY t.Fecha)t2";
            comm.CommandType = CommandType.Text;
            comm.Parameters.AddWithValue("@IHIdEquipo", IdEquipo);
            comm.Parameters.AddWithValue("@IHAnio", Anio);
            comm.Parameters.AddWithValue("@IHMes", Mes);


            dr = comm.ExecuteReader();
            dr.Read();
            Turno1 = dr["Turno1"].ToString();
            Turno2 = dr["Turno2"].ToString();
            Turno3 = dr["Turno3"].ToString();

            dr.Close();
            comm.Parameters.Clear();
            comm.Connection = conexion.CerrarConexion();



        }


        public void LeerDatosHoras(int IdInstalacion, int Anio, int Mes)
        {
            comm.Connection = conexion.AbrirConexion();
            comm.CommandText = "SELECT ISNULL(CONVERT(varchar,CAST(CAST(SUM(t3.Promedio)/ NULLIF((COUNT(t3.T1)+COUNT(t3.T2)+COUNT(t3.T3)),0) as DECIMAL(8,3)) as money),1),0) Promedio FROM (SELECT ISNULL(CAST((ISNULL(AVG(t2.Turno1), 0) + ISNULL(AVG(t2.Turno2), 0) + ISNULL(AVG(t2.Turno3), 0)) AS DECIMAL(8, 3)), 0) Promedio, AVG(t2.Turno1) T1, AVG(t2.Turno2) T2, AVG(t2.Turno3) T3 FROM(SELECT t.Fecha, CAST(AVG(CAST(t.t1 as decimal (8, 3))) as money)'Turno1', CAST(AVG(CAST(t.t2 as decimal (8, 3))) as money)'Turno2', CAST(AVG(CAST(t.t3 as decimal (8, 3))) as money)'Turno3' from(SELECT a.Id_equipo, a.Equipo, a.Fecha, CAST(CAST(t1.Velocidad / ((t1.Elasticidad / 100 + 1) * t1.NoPasada) * .60 as decimal(8, 3)) * .85 * t1.Bandas * a.Turno1 as money) 't1', CAST(CAST(t2.Velocidad / ((t2.Elasticidad / 100 + 1) * t2.NoPasada) * .60 as decimal(8, 3)) * .85 * t2.Bandas * a.Turno2 as money) 't2', CAST(CAST(t3.Velocidad / ((t3.Elasticidad / 100 + 1) * t3.NoPasada) * .60 as decimal(8, 3)) * .85 * t3.Bandas * a.Turno3 as money) 't3' FROM(SELECT t.Id_equipo, t.Nombre 'Equipo', CONVERT(NVARCHAR, t.Fecha, 105) Fecha, t.T1 'Turno1', t.T2 'Turno2', t.T3 'Turno3' FROM(SELECT a.[Id_equipo], b.Nombre, CASE WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= inicio AND CONVERT(Time(0), fin_averia) < fin THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) > '23:00:00.0000000' THEN CONVERT(date, DATEADD(day, 1, fin_averia)) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), fin_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), fin_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) <= '23:59:00.0000000' THEN CONVERT(date, DATEADD(day, 1, fin_averia)) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '07:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0 THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), fin_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '15:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000'  AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0 THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '23:00:00.0000000'  THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), fin_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000'  THEN CONVERT(date, fin_averia) END AS Fecha, CAST(8 - SUM(CASE WHEN c.Nombre = 'Turno1' THEN CASE WHEN CONVERT(Time(0), ini_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN DATEDIFF(minute, ini_averia, fin_averia) ELSE CASE WHEN CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN DATEDIFF(minute, ini_averia, fin_averia) ELSE CASE WHEN CONVERT(Time(0), ini_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) > '23:00:00.0000000' THEN DATEDIFF(minute, ini_averia, fin_averia) ELSE CASE WHEN CONVERT(Time(0), fin_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN DATEDIFF(minute, '00:00:00.0000000', CONVERT(Time(0), fin_averia)) ELSE CASE WHEN CONVERT(Time(0), fin_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) <= '23:59:00.0000000' THEN DATEDIFF(minute, '23:00:00.0000000', CONVERT(Time(0), fin_averia)) ELSE CASE WHEN CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '07:00:00.0000000' THEN DATEDIFF(minute, CONVERT(Time(0), ini_averia), '07:00:00.0000000') ELSE NULL END END END END END END END) * 1.0 / 60 * 1.0 AS DECIMAL(10, 1)) AS 'T1', CAST(8 - SUM(CASE WHEN c.Nombre = 'Turno2' THEN CASE WHEN CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0 THEN DATEDIFF(minute, ini_averia, fin_averia) ELSE CASE WHEN CONVERT(Time(0), fin_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' THEN DATEDIFF(minute, '07:00:00.0000000', CONVERT(Time(0), fin_averia)) ELSE CASE WHEN CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '15:00:00.0000000' THEN DATEDIFF(minute, CONVERT(Time(0), ini_averia), '15:00:00.0000000') ELSE NULL END END END END) * 1.0 / 60 * 1.0 AS DECIMAL(10, 1)) AS 'T2', CAST(8 - SUM(CASE WHEN c.Nombre = 'Turno3' THEN CASE WHEN CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000' AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0 THEN DATEDIFF(minute, ini_averia, fin_averia) ELSE CASE WHEN CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '23:00:00.0000000' THEN DATEDIFF(minute, CONVERT(Time(0), ini_averia), '23:00:00.0000000') ELSE CASE WHEN CONVERT(Time(0), fin_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000' THEN DATEDIFF(minute, '15:00:00.0000000', CONVERT(Time(0), fin_averia)) ELSE NULL END END END END) * 1.0 / 60 * 1.0 AS DECIMAL(10, 1)) AS 'T3' FROM[orygon].[dbo].[op_fallas] a INNER JOIN Cat_equipo b ON a.Id_equipo = b.Id_equipo INNER JOIN Cat_Turno c ON b.Id_instalacion = c.Id_instalacion WHERE b.Id_instalacion = @IHIdInstalacion AND DATEDIFF(minute, ini_averia, fin_averia) > 2 and b.Activado IS NULL GROUP BY a.[Id_equipo], b.Nombre, CASE WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= inicio AND CONVERT(Time(0), fin_averia) < fin THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) > '23:00:00.0000000' THEN CONVERT(date, DATEADD(day, 1, fin_averia)) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), fin_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '07:00:00.0000000' THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), fin_averia) >= '23:00:00.0000000' AND CONVERT(Time(0), fin_averia) <= '23:59:00.0000000' THEN CONVERT(date, DATEADD(day, 1, fin_averia)) WHEN c.Nombre = 'Turno1' AND CONVERT(Time(0), ini_averia) >= '00:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '07:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0 THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), fin_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '15:00:00.0000000' THEN CONVERT(date, fin_averia) WHEN c.Nombre = 'Turno2' AND CONVERT(Time(0), ini_averia) >= '07:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '15:00:00.0000000' THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000'  AND DATEDIFF(minute, ini_averia, fin_averia) < 480 AND DATEDIFF(day, ini_averia, fin_averia) = 0  THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), ini_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), ini_averia) < '23:00:00.0000000'  THEN CONVERT(date, ini_averia) WHEN c.Nombre = 'Turno3' AND CONVERT(Time(0), fin_averia) >= '15:00:00.0000000' AND CONVERT(Time(0), fin_averia) < '23:00:00.0000000'  THEN CONVERT(date, fin_averia) END) t WHERE t.Fecha IS NOT NULL AND MONTH(t.Fecha) = @IHMes AND YEAR(t.Fecha) = @IHAnio) a LEFT JOIN(SELECT  pram.Id_Equipo, pram.Fecha, pram.Velocidad, pram.Elasticidad, pram.Bandas, mat.NoPasada, CONVERT(NVARCHAR, CAST(pram.Fecha AS Date), 105) 'Fecha2' FROM Op_ParametrosOperacion pram JOIN(SELECT DISTINCT max(fecha) 'Fecha' from Op_ParametrosOperacion WHERE Activado IS NULL AND CONVERT(Time(0), fecha) >= '00:00:00.0000000' AND CONVERT(Time(0), fecha) < '07:00:00.0000000' AND MONTH(Fecha)=@IHMes AND YEAR(Fecha)=@IHAnio GROUP BY CAST(Fecha as DATE)) t on pram.Fecha = t.Fecha LEFT JOIN Cat_Material mat on pram.Id_Material = mat.Id_Material) t1 on a.Id_equipo = t1.Id_Equipo and a.Fecha = t1.Fecha2 LEFT JOIN(SELECT pram.Id_Equipo, pram.Fecha, pram.Velocidad, pram.Elasticidad, pram.Bandas, mat.NoPasada, CONVERT(NVARCHAR, CAST(pram.Fecha AS Date), 105) 'Fecha2' FROM Op_ParametrosOperacion pram JOIN(SELECT DISTINCT max(fecha) 'Fecha' from Op_ParametrosOperacion WHERE Activado IS NULL AND CONVERT(Time(0), fecha) >= '07:00:00.0000000' AND CONVERT(Time(0), fecha) < '15:00:00.0000000' AND MONTH(Fecha)=@IHMes AND YEAR(Fecha)=@IHAnio GROUP BY CAST(Fecha as DATE)) t on pram.Fecha = t.Fecha LEFT JOIN Cat_Material mat on pram.Id_Material = mat.Id_Material) t2 on a.Id_Equipo = t2.Id_Equipo and a.Fecha = t2.Fecha2 LEFT JOIN(SELECT pram.Id_Equipo, pram.Fecha, pram.Velocidad, pram.Elasticidad, pram.Bandas, mat.NoPasada, CONVERT(NVARCHAR, CAST(pram.Fecha AS Date), 105) 'Fecha2' FROM Op_ParametrosOperacion pram JOIN(SELECT DISTINCT max(fecha) 'Fecha' from Op_ParametrosOperacion WHERE Activado IS NULL AND CONVERT(Time(0), fecha) >= '15:00:00.0000000' AND CONVERT(Time(0), fecha) < '23:00:00.0000000' AND MONTH(Fecha)=@IHMes AND YEAR(Fecha)=@IHAnio GROUP BY CAST(Fecha as DATE)) t on pram.Fecha = t.Fecha LEFT JOIN Cat_Material mat on pram.Id_Material = mat.Id_Material) t3 on a.Id_Equipo = t3.Id_Equipo and a.Fecha = t3.Fecha2)t GROUP BY t.Fecha)t2)t3";
            comm.CommandType = CommandType.Text;
            comm.Parameters.AddWithValue("@IHIdInstalacion", IdInstalacion);
            comm.Parameters.AddWithValue("@IHAnio", Anio);
            comm.Parameters.AddWithValue("@IHMes", Mes);


            dr = comm.ExecuteReader();
            dr.Read();
            PromedioHora = dr["Promedio"].ToString();
            dr.Close();
            comm.Parameters.Clear();
            comm.Connection = conexion.CerrarConexion();



        }
    }
}